<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Shared Cell Manager</title>

<style>
body { margin:0; font-family:Arial; background:#1c1c1c; color:#fff }
header { background:#111; padding:12px; display:flex; justify-content:space-between; position:sticky; top:0 }
.menu { position:relative }
.menu-btn { background:none; border:none; color:#fff; font-size:22px }
.menu-content { display:none; position:absolute; right:0; top:28px; background:#2a2a2a; border-radius:6px; min-width:200px }
.menu-content button { width:100%; padding:10px; background:none; border:none; color:#fff; text-align:left }
.menu-content button:hover { background:#3a3a3a }

select { background:#2a2a2a; color:#fff; border:none; padding:6px; border-radius:4px }

.grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; padding:16px }
.cell {
  background:#3a5f3a;
  padding:28px 0;
  text-align:center;
  font-size:22px;
  border-radius:10px;
  user-select:none;
}
.cell.active { background:red; animation:blink 1s infinite }
.cell.working { background:yellow; color:#000 }
.cell.transition { animation:done 2s linear }

@keyframes blink { 50% { opacity:.3 } }
@keyframes done {
  0% { background:blue }
  25% { background:green }
  50% { background:blue }
  75% { background:green }
  100% { background:#3a5f3a }
}

.pagination { display:flex; justify-content:center; gap:12px; padding-bottom:70px }
button { background:#00aa00; border:none; padding:10px 18px; border-radius:20px }

.ticker {
  position:fixed; bottom:0; width:100%;
  background:#000; color:#0f0;
  white-space:nowrap; overflow:hidden;
  padding:10px; font-size:18px;
}
.ticker span { display:inline-block; padding-left:100%; animation:scroll 15s linear infinite }
@keyframes scroll { to { transform:translateX(-100%) } }
</style>
</head>

<body>
<header>
  <div id="deptTitle">Department</div>
  <div>
    <select id="deptSelect"></select>
    <span class="menu">
      <button class="menu-btn" id="menuBtn">⋮</button>
      <div class="menu-content" id="menuContent">
        <button id="renameCell">Rename Cell</button>
        <button id="workingCell">Working on Cell</button>
        <button id="resetAll">Reset All</button>
      </div>
    </span>
  </div>
</header>

<div class="grid" id="grid"></div>

<div class="pagination">
  <button id="prev">Prev</button>
  <span id="pageInfo"></span>
  <button id="next">Next</button>
</div>

<div class="ticker"><span id="tickerText">No active cells</span></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let state = {};
let currentDept = null;
let currentPage = 1;
const PER_PAGE = 10;
let selectedCell = null;

const grid = document.getElementById("grid");
const deptSelect = document.getElementById("deptSelect");
const deptTitle = document.getElementById("deptTitle");
const pageInfo = document.getElementById("pageInfo");
const tickerText = document.getElementById("tickerText");
const menuContent = document.getElementById("menuContent");

function closeMenu(){ menuContent.style.display="none"; }

document.getElementById("menuBtn").onclick = e => {
  e.stopPropagation();
  menuContent.style.display="block";
};

document.addEventListener("click", closeMenu);
document.addEventListener("touchstart", closeMenu, { passive:true });

socket.on("state:init", s => {
  state = s;
  if (!currentDept) currentDept = Object.keys(state.departments)[0];
  render();
});

function sync(){ socket.emit("state:update", state); }

function render(){
  const cells = state.departments[currentDept];
  grid.innerHTML="";
  const slice = cells.slice((currentPage-1)*PER_PAGE, currentPage*PER_PAGE);

  slice.forEach(c=>{
    const d = document.createElement("div");
    d.className = "cell" +
      (c.active?" active":"") +
      (c.working?" working":"") +
      (c.transition?" transition":"");

    d.textContent = c.name;

    d.onclick = () => {
      c.active = !c.active;
      c.working = false;
      render(); sync();
    };

    let timer;
    d.addEventListener("touchstart", ()=> {
      timer = setTimeout(()=> {
        selectedCell = c;
        menuContent.style.display="block";
      },600);
    });
    d.addEventListener("touchend", ()=> clearTimeout(timer));

    d.oncontextmenu = e => {
      e.preventDefault();
      selectedCell = c;
      menuContent.style.display="block";
    };

    grid.appendChild(d);
  });

  pageInfo.textContent = `Page ${currentPage}`;
  updateTicker();
}

function updateTicker(){
  const list=[];
  Object.entries(state.departments).forEach(([d,cells])=>{
    cells.filter(c=>c.active||c.working)
      .forEach(c=>list.push(`${d}:${c.name}`));
  });
  tickerText.textContent = list.length?list.join(" • "):"No active cells";
}

document.getElementById("workingCell").onclick = ()=>{
  closeMenu();
  if(!selectedCell) return;

  if(selectedCell.working){
    selectedCell.working=false;
    selectedCell.transition=true;
    render();
    setTimeout(()=>{
      selectedCell.transition=false;
      render(); sync();
    },2000);
    return;
  }

  selectedCell.working=true;
  selectedCell.active=false;
  render(); sync();
};

document.getElementById("renameCell").onclick = ()=>{
  closeMenu();
  if(!selectedCell) return;
  const n = prompt("Cell name", selectedCell.name);
  if(n){ selectedCell.name=n; render(); sync(); }
};

document.getElementById("resetAll").onclick = ()=>{
  closeMenu();
  Object.values(state.departments)
    .forEach(cs=>cs.forEach(c=>{
      c.active=false; c.working=false;
    }));
  render(); sync();
};

document.getElementById("prev").onclick=()=>{ if(currentPage>1){currentPage--;render()} };
document.getElementById("next").onclick=()=>{ currentPage++; render() };
</script>
</body>
</html>
