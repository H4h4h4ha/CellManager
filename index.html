<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shared Cell Manager</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #1c1c1c;
      color: #fff;
    }

    header {
      position: sticky;
      top: 0;
      background: #111;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .menu { position: relative; }
    .menu-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
    }

    .menu-content {
      display: none;
      position: absolute;
      right: 0;
      top: 30px;
      background: #2a2a2a;
      border-radius: 6px;
      min-width: 160px;
    }

    .menu-content button {
      width: 100%;
      padding: 10px;
      background: none;
      border: none;
      color: #fff;
      text-align: left;
    }

    .menu-content button:hover { background: #3a3a3a; }

    select {
      background: #2a2a2a;
      color: #fff;
      border: none;
      padding: 6px;
      border-radius: 4px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 16px;
    }

    .cell {
      background: #3a5f3a;
      border-radius: 8px;
      padding: 20px 0;
      text-align: center;
      font-size: 18px;
    }

    .cell.active {
      background: red;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%,100% { opacity:1; }
      50% { opacity:0.3; }
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding-bottom: 70px;
    }

    button {
      background: #00aa00;
      color: #000;
      border: none;
      padding: 10px 18px;
      border-radius: 20px;
    }

    .ticker {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #000;
      color: #0f0;
      overflow: hidden;
      white-space: nowrap;
      padding: 8px 0;
    }

    .ticker span {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 15s linear infinite;
    }

    @keyframes scroll {
      from { transform: translateX(0); }
      to { transform: translateX(-100%); }
    }
  </style>
</head>
<body>

<header>
  <div id="deptTitle">Department</div>
  <div>
    <select id="deptSelect"></select>
    <span class="menu">
      <button class="menu-btn" id="menuBtn">⋮</button>
      <div class="menu-content" id="menuContent">
        <button id="addDept">Add Department</button>
        <button id="renameDept">Rename Department</button>
        <button id="renameCell">Rename Cell</button>
        <button id="resetAll">Reset All</button>
      </div>
    </span>
  </div>
</header>

<div class="grid" id="grid"></div>

<div class="pagination">
  <button id="prev">Prev</button>
  <span id="pageInfo"></span>
  <button id="next">Next</button>
</div>

<div class="ticker"><span id="tickerText">No active cells</span></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let state = { departments: {} };
let currentDept = null;
let currentPage = 1;
const PER_PAGE = 10;
let selectedCell = null;

const grid = document.getElementById('grid');
const deptSelect = document.getElementById('deptSelect');
const deptTitle = document.getElementById('deptTitle');
const pageInfo = document.getElementById('pageInfo');
const tickerText = document.getElementById('tickerText');

socket.on('state:init', s => {
  state = s;
  if (!currentDept) currentDept = Object.keys(state.departments)[0];
  renderDepartments();
  render();
});

function sync() {
  socket.emit('state:update', state);
}

function renderDepartments() {
  deptSelect.innerHTML = '';
  Object.keys(state.departments).forEach(d => {
    const o = document.createElement('option');
    o.value = d; o.textContent = d;
    deptSelect.appendChild(o);
  });
  deptSelect.value = currentDept;
  deptTitle.textContent = currentDept;
}

deptSelect.onchange = e => {
  currentDept = e.target.value;
  currentPage = 1;
  render();
};

function render() {
  const cells = state.departments[currentDept];
  grid.innerHTML = '';
  const slice = cells.slice((currentPage-1)*PER_PAGE, currentPage*PER_PAGE);
  slice.forEach(c => {
    const div = document.createElement('div');
    div.className = 'cell' + (c.active ? ' active' : '');
    div.textContent = c.name;
    div.onclick = () => {
      c.active = !c.active;
      sync();
    };
    div.oncontextmenu = e => {
      e.preventDefault();
      selectedCell = c;
    };
    grid.appendChild(div);
  });
  pageInfo.textContent = `Page ${currentPage}`;
  updateTicker();
}

function updateTicker() {
  const list = [];
  Object.entries(state.departments).forEach(([d, cells]) => {
    cells.filter(c => c.active).forEach(c => list.push(`${d}:${c.name}`));
  });
  tickerText.textContent = list.length ? list.join(' • ') : 'No active cells';
}

prev.onclick = () => { if (currentPage>1) { currentPage--; render(); }};
next.onclick = () => { currentPage++; render(); };

menuBtn.onclick = () => menuContent.style.display = menuContent.style.display==='block'?'none':'block';

addDept.onclick = () => {
  const n = prompt('Department name');
  if (!n) return;
  state.departments[n] = Array.from({length:100},(_,i)=>({name:String(i+1),active:false}));
  currentDept = n;
  sync();
};

renameDept.onclick = () => {
  const n = prompt('New name', currentDept);
  if (!n) return;
  state.departments[n] = state.departments[currentDept];
  delete state.departments[currentDept];
  currentDept = n;
  sync();
};

renameCell.onclick = () => {
  if (!selectedCell) return alert('Long-press cell first');
  const n = prompt('Cell name', selectedCell.name);
  if (n) selectedCell.name = n;
  sync();
};

resetAll.onclick = () => {
  Object.values(state.departments).forEach(cells => cells.forEach(c => c.active=false));
  sync();
};

// init default
socket.emit('state:update', {
  departments: { Default: Array.from({length:100},(_,i)=>({name:String(i+1),active:false})) }
});
</script>
</body>
</html>
